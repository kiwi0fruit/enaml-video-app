#!/bin/bash
this_script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# <custom vars>
source "${this_script_dir}/env_pre"
# </custom vars>


# <miniconda path confirmation>
_bin="bin"
_python="bin/python"
case "$(uname -s)" in
    MINGW*)
        _bin="Scripts"
        _python="python.exe" ;;
esac

miniconda_dir="~/miniconda3"
function yes_or_no {
    while true; do
        echo ""
        echo "Is Miniconda/Anaconda installed to \"${miniconda_dir}\"? (yes/no)"
        read -p "Type 'y' or 'n': " yn
        case $yn in
            [Yy]*) return 0 ;;  
            [Nn]*) return 1 ;;
            *) echo "Please type 'y' or 'n' only" ;;
        esac
    done
}

_conda="${miniconda_dir}/${_bin}/conda"
while true; do
    if [ -f "$_conda" ]; then
        yes_or_no && break
    else
        echo "\"${_conda}\" was not found!"
    fi
    echo ""
    echo "Please type the path to Miniconda/Anaconda folder."
    echo "(you can drag'n'drop or paste it right here)"
    read -p "Type the path (or 'x' to exit): " miniconda_dir
    _conda="${miniconda_dir}/${_bin}/conda"
    if [ "${miniconda_dir}" == "x" ]; then
        return 0
    fi
done
# </miniconda path confirmation>


# <main>
cd "${this_script_dir}"

export PYTHONNOUSERSITE=1

_prefix="${miniconda_dir}/envs/$env"

_conda="${miniconda_dir}/${_bin}/conda"
_activate="${miniconda_dir}/${_bin}/activate"
_deactivate="${miniconda_dir}/${_bin}/deactivate"
_pip="${_prefix}/${_bin}/pip"
_python="${_prefix}/${_python}"
_root_python="${miniconda_dir}/${_python}"

"$_conda" env remove --name "$env"
"$_root_python" "${this_script_dir}/_clear_global_channels.py" "$_conda"
"$_conda" env create --file "$yaml"
# Do not specify custom -p/--prefix path as
# this might make shortcut creation fail.
# If you need so specify custom prefix
# first add ${miniconda_dir}/${_bin} to the PATH
# and change ${_prefix} accordingly.
source "$_activate" "$env"
# </main>


# <custom commands after activate>
source "${this_script_dir}/env_post"
# </custom commands after activate>


source "$_deactivate"
